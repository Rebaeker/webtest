---
// filepath: /Users/timehmann/Dokumente/Programmieren/SmallProjects/webtest/src/pages/login.astro
import Layout from "../layouts/Layout.astro";
---

<Layout title="Login - Lost and Found Web" active="login">
  <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          Anmelden oder Registrieren
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600">
          Melden Sie sich an, um Gegenst√§nde zu melden
        </p>
      </div>

      <!-- Login/Signup Toggle -->
      <div class="flex rounded-lg bg-gray-100 p-1">
        <button id="loginTab" class="flex-1 rounded-md py-2 px-4 text-sm font-medium transition-all bg-white text-blue-600 shadow-sm">
          Anmelden
        </button>
        <button id="signupTab" class="flex-1 rounded-md py-2 px-4 text-sm font-medium transition-all text-gray-500 hover:text-gray-700">
          Registrieren
        </button>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="mt-8 space-y-6">
        <div class="space-y-4">
          <div>
            <label for="loginEmail" class="block text-sm font-medium text-gray-700">E-Mail-Adresse</label>
            <input 
              id="loginEmail" 
              name="email" 
              type="email" 
              required 
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
              placeholder="ihre@email.com"
            >
          </div>
          <div>
            <label for="loginPassword" class="block text-sm font-medium text-gray-700">Passwort</label>
            <input 
              id="loginPassword" 
              name="password" 
              type="password" 
              required 
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
              placeholder="Passwort"
            >
          </div>
        </div>

        <div>
          <button 
            type="submit" 
            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Anmelden
          </button>
        </div>
      </form>

      <!-- Signup Form -->
      <form id="signupForm" class="mt-8 space-y-6 hidden">
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="signupPrename" class="block text-sm font-medium text-gray-700">Vorname</label>
              <input 
                id="signupPrename" 
                name="prename" 
                type="text" 
                required 
                class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
                placeholder="Max"
              >
            </div>
            <div>
              <label for="signupSurname" class="block text-sm font-medium text-gray-700">Nachname</label>
              <input 
                id="signupSurname" 
                name="surname" 
                type="text" 
                required 
                class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
                placeholder="Mustermann"
              >
            </div>
          </div>
          <div>
            <label for="signupEmail" class="block text-sm font-medium text-gray-700">E-Mail-Adresse</label>
            <input 
              id="signupEmail" 
              name="email" 
              type="email" 
              required 
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
              placeholder="max@example.com"
            >
          </div>
          <div>
            <label for="signupPhone" class="block text-sm font-medium text-gray-700">Telefonnummer</label>
            <input 
              id="signupPhone" 
              name="phone" 
              type="tel" 
              required 
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
              placeholder="+49 123 456789"
            >
          </div>
          <div>
            <label for="signupPassword" class="block text-sm font-medium text-gray-700">Passwort</label>
            <input 
              id="signupPassword" 
              name="password" 
              type="password" 
              required 
              class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
              placeholder="Mindestens 6 Zeichen"
              minlength="6"
            >
          </div>
        </div>

        <div>
          <button 
            type="submit" 
            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
          >
            Registrieren
          </button>
        </div>
      </form>

      <!-- Message Area -->
      <div id="message" class="text-center hidden">
        <p id="messageText" class="text-sm"></p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loginTab = document.getElementById('loginTab');
      const signupTab = document.getElementById('signupTab');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const message = document.getElementById('message');
      const messageText = document.getElementById('messageText');

      // Tab switching
      loginTab.addEventListener('click', () => {
        loginTab.className = 'flex-1 rounded-md py-2 px-4 text-sm font-medium transition-all bg-white text-blue-600 shadow-sm';
        signupTab.className = 'flex-1 rounded-md py-2 px-4 text-sm font-medium transition-all text-gray-500 hover:text-gray-700';
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
      });

      signupTab.addEventListener('click', () => {
        signupTab.className = 'flex-1 rounded-md py-2 px-4 text-sm font-medium transition-all bg-white text-green-600 shadow-sm';
        loginTab.className = 'flex-1 rounded-md py-2 px-4 text-sm font-medium transition-all text-gray-500 hover:text-gray-700';
        signupForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      });

      // Login form submission
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleAuth('login', new FormData(loginForm));
      });

      // Signup form submission
      signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleAuth('signup', new FormData(signupForm));
      });

      async function handleAuth(action, formData) {
        const data = {
          action: action,
          email: formData.get('email'),
          password: formData.get('password')
        };

        if (action === 'signup') {
          data.prename = formData.get('prename');
          data.surname = formData.get('surname');
          data.phone = formData.get('phone');
        }

        try {
          const response = await fetch('/api/auth', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success === 'ok') {
            showMessage(result.message, 'success');
            // Store user info in localStorage for frontend access
            localStorage.setItem('user', JSON.stringify(result.user));
            // Redirect to items page or previous page
            setTimeout(() => {
              window.location.href = '/items/';
            }, 1000);
          } else {
            showMessage(result.message, 'error');
          }
        } catch (error) {
          console.error('Auth error:', error);
          showMessage('Verbindungsfehler. Bitte versuchen Sie es erneut.', 'error');
        }
      }

      function showMessage(text, type) {
        messageText.textContent = text;
        message.className = `text-center ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        message.classList.remove('hidden');
        
        setTimeout(() => {
          message.classList.add('hidden');
        }, 5000);
      }
    });
  </script>
</Layout>